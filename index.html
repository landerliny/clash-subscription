<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clash 订阅管理</title>
    <script src="https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; }
        input, select, button { padding: 10px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        button { background: #007cba; color: white; border: none; cursor: pointer; }
        #result { margin-top: 20px; padding: 15px; background: #f5f5f5; display: none; }
        #qrcode { margin-top: 10px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>Clash 订阅链接生成器</h1>
    
    <div id="loginSection">
        <h3>管理员登录</h3>
        <div class="formgroup">
            <input type="password" id="adminPassword" placeholder="输入管理密码">
            <button onclick="verifyPassword()">验证密码</button>
        </div>
    </div>

    <div id="adminSection" class="hidden">
        <h3>生成订阅链接</h3>
        <div class="formgroup">
            <label for="userId">用户标识（例如：user001）</label>
            <input type="text" id="userId" placeholder="输入用户ID">
        </div>
        <div class="formgroup">
            <label for="expireDays">有效期</label>
            <select id="expireDays">
                <option value="30">1个月</option>
                <option value="365">1年</option>
                <option value="730">2年</option>
                <option value="9999">永久</option>
            </select>
        </div>
        <button onclick="generateLink()">生成订阅链接</button>
        
        <div id="result" class="hidden">
            <p><strong>订阅链接：</strong></p>
            <p id="subscribeUrl"></p>
            <button onclick="copyToClipboard()">复制链接</button>
            <p><strong>二维码：</strong></p>
            <div id="qrcode"></div>
        </div>
    </div>

    <script>
        function verifyPassword() {
            const password = document.getElementById('adminPassword').value;
            if (!password) {
                alert('请输入密码');
                return;
            }
            // 简单的前端验证，实际应由后端验证
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('adminSection').classList.remove('hidden');
        }

        async function generateLink() {
            const userId = document.getElementById('userId').value;
            const expireDays = document.getElementById('expireDays').value;
            const password = document.getElementById('adminPassword').value;

            if (!userId) {
                alert('请输入用户ID');
                return;
            }

            console.log('开始API调用...');

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + password
                    },
                    body: JSON.stringify({ 
                        userId: userId, 
                        expireDays: parseInt(expireDays) 
                    })
                });

                console.log('响应状态:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('响应数据:', data);

                document.getElementById('subscribeUrl').innerText = data.subscribeUrl;
                document.getElementById('result').classList.remove('hidden');

                // 生成二维码
                document.getElementById('qrcode').innerHTML = '';
                QRCode.toCanvas(document.getElementById('qrcode'), data.subscribeUrl);

            } catch (error) {
                console.error('错误详情:', error);
                alert('错误: ' + error.message + '。请查看控制台(F12)获取详细信息。');
            }
        }

        function copyToClipboard() {
            const urlText = document.getElementById('subscribeUrl').innerText;
            navigator.clipboard.writeText(urlText).then(function() {
                alert('链接已复制到剪贴板！');
            });
        }
    </script>
</body>
</html>
